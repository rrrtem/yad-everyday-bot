# StartCommand Module Architecture

–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã `/start` –≤ Telegram –±–æ—Ç–µ.

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```mermaid
graph TD
    A["üì± index.ts<br/>(main entry point)"] --> B["üîÑ startCommand/index.ts<br/>(main router)"]
    C["‚öôÔ∏è commandHandler.ts"] --> B
    D["üß™ startTest.ts"] --> B
    
    B --> E["üîç UserAnalyzer"]
    E --> F{"User Type?"}
    
    F -->|new_user| G["üìù NewUserFlow"]
    F -->|active_user| H["‚úÖ ActiveUserFlow"]
    F -->|continue_setup| I["üîÑ ContinueSetupFlow"]
    F -->|returning_user| J["üëã ReturningUserFlow"]
    
    G --> K["‚öôÔ∏è SetupProcess"]
    J --> K
    I --> K
    
    K --> L["üéØ StateHandlers"]
    L --> M["üìù ModeSelectionHandler"]
    L --> N["üé´ PromoCodeHandler"]
    
    M --> O["üí≥ PaymentHandler"]
    N --> O
    
    style B fill:#e8f5e8
    style E fill:#fff3e0
    style K fill:#f3e5f5
    style L fill:#e3f2fd
    style O fill:#f1f8e9
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
startCommand/
‚îú‚îÄ‚îÄ README.md                   # üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
‚îú‚îÄ‚îÄ index.ts                    # üîÑ –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä
‚îú‚îÄ‚îÄ UserAnalyzer.ts             # üîç –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îú‚îÄ‚îÄ flows/                      # üìã Flows –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ NewUserFlow.ts          # üìù –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ ActiveUserFlow.ts       # ‚úÖ –£–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ ReturningUserFlow.ts    # üëã –í–æ–∑–≤—Ä–∞—â–∞—é—â–∏–µ—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ ContinueSetupFlow.ts    # üîÑ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
‚îî‚îÄ‚îÄ states/                     # ‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π
    ‚îú‚îÄ‚îÄ index.ts                # üéØ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    ‚îú‚îÄ‚îÄ SetupProcess.ts         # ‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îú‚îÄ‚îÄ ModeSelectionHandler.ts # üìù –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
    ‚îú‚îÄ‚îÄ PromoCodeHandler.ts     # üé´ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    ‚îî‚îÄ‚îÄ PaymentHandler.ts       # üí≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
```

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
`UserAnalyzer` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **new_user** - –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≤ –ë–î –Ω–æ –Ω–æ–≤—ã–π –¥–ª—è —á–∞—Ç–∞
- **active_user** - —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (in_chat = true)
- **continue_setup** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (user_state != null)
- **returning_user** - –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (joined_at != null)

### 2. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è Flow
–ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–µ—Ä (`index.ts`) –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É Flow:

#### NewUserFlow
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–∞

#### ActiveUserFlow  
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω

#### ReturningUserFlow
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- –ù–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ —á–∞—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–Ω–∏) –∏–ª–∏ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É

#### ContinueSetupFlow
- –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞ –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è: waiting_mode, waiting_promo, payment_link_sent

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
`StateHandlers` —É–ø—Ä–∞–≤–ª—è—é—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏:

#### SetupProcess
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î

#### ModeSelectionHandler
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º (text/image)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç —Ä–∏—Ç–º daily
- –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–ø–ª–∞—Ç—ã

#### PromoCodeHandler
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–ª—É–±–∞

#### PaymentHandler
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫–ª—É–±–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–Ω–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **–ß—ë—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É
2. **–õ–µ–≥–∫–æ —á–∏—Ç–∞–µ—Ç—Å—è** - –ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ  
3. **–õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** - –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ
4. **–õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
5. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –∏–º–ø–æ—Ä—Ç—ã –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –∫ –Ω—É–∂–Ω—ã–º –º–æ–¥—É–ª—è–º

## üìù –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–ø–æ logic.md)

–ú–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ª–æ–≥–∏–∫—É **A1. /start ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** –∏–∑ `logic.md`:

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è** - UserAnalyzer
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** - –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è Flow  
3. **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π Flow
4. **–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞** - SetupProcess + ModeSelectionHandler
5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∏—Ç–º–∞** - daily –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã** - PaymentHandler

## üìà –£–ø—Ä–æ—â–µ–Ω–∏—è –≤ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏

- **–£–±—Ä–∞–Ω –≤—ã–±–æ—Ä —Ä–∏—Ç–º–∞** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è `daily` –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
- **–û—Ç–¥–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ ChangePace** - –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Ä–∏—Ç–º –ø–æ–∑–∂–µ
- **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ñ–ª–æ—É** - —Ä–µ–∂–∏–º ‚Üí –æ–ø–ª–∞—Ç–∞ (–±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ä–∏—Ç–º–∞)

## üîß –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã

–í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ `/supabase/functions/constants.ts`:
- MSG_WELCOME, MSG_WELCOME_ALREADY_ACTIVE - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
- MSG_MODE - –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
- MSG_PROMO, MSG_PROMO_ERR - –ø—Ä–æ–º–æ–∫–æ–¥—ã
- MSG_LINK_CLUB, MSG_LINK_STANDARD - —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
- AVAILABLE_MODES - –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∂–∏–º—ã
- AVAILABLE_PACES.DAILY - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º—ã–π —Ä–∏—Ç–º
- VALID_PROMO_CODES - –≤–∞–ª–∏–¥–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã

## üì• –ò–º–ø–æ—Ä—Ç—ã

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è:

```typescript
// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
import { handleStartCommand, handleStartCallbackQuery } from "./startCommand/index.ts";

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π  
import { handleModeSelection, handlePromoCode, handleNoPromo } from "./startCommand/states/index.ts";
``` 