# CronHandler Module

Модуль для обработки крон-задач YAD-Everyday бота. Разделен на отдельные компоненты для лучшей организации кода.

## Структура

```
cronHandler/
├── flows/                    # Основные потоки крон-задач
│   ├── DailyCronFlow.ts     # Ежедневная проверка (04:00 UTC)
│   ├── WeeklyCronFlow.ts    # Еженедельная проверка для weekly пользователей
│   ├── PublicReminderFlow.ts # Публичные напоминания (20:00 UTC)
│   └── AllInfoFlow.ts       # Отправка детального отчета админу
├── helpers/                 # Вспомогательные модули
│   ├── UserProcessor.ts     # Обработка логики пользователей
│   ├── ReportGenerator.ts   # Генерация отчетов и сообщений
│   ├── AdminReporter.ts     # Централизованная отправка отчетов админу
│   └── ChatManager.ts       # Работа с чатом (удаление, отправка)
├── index.ts                 # Главный файл с экспортами
└── README.md               # Этот файл
```

## Функции

### DailyCronFlow (dailyCron)
**Время:** 04:00 UTC каждый день  
**Логика:** Б2 из logic.md

Основные задачи:
1. Проверка страйков для пользователей с ежедневным ритмом
2. Обработка пользователей на паузе
3. Обработка подписок (subscription_days_left)
4. Удаление пользователей с истекшей подпиской
5. Сброс флагов post_today
6. Анализ опасных случаев
7. Отправка отчета владельцу

### WeeklyCronFlow (weeklyCron)
**Время:** Раз в неделю (настраивается в cron)  
**Логика:** Упрощенная версия daily проверки

Основные задачи:
1. Получение пользователей с pace=weekly и in_chat=true
2. Применение фильтров (пауза, public_remind)
3. Проверка наличия постов (post_today=true)
4. Обновление статистики (units_count, consecutive_posts_count)
5. Сброс страйков при наличии поста
6. Сброс флагов post_today для weekly пользователей
7. Отправка отчета админу

### PublicReminderFlow (publicDeadlineReminder)
**Время:** 20:00 UTC каждый день  
**Логика:** Б3 из logic.md

Основные задачи:
1. Вычисление времени до конца дня (04:00 UTC)
2. Фильтрация пользователей для напоминаний
3. Отправка напоминаний в разные треды (text/image)

### AllInfoFlow (allInfo)
**Время:** По запросу через команду /allinfo

Основные задачи:
1. Сбор статистики пользователей (без изменения данных)
2. Анализ опасных случаев
3. Отправка детального отчета владельцу

## Вспомогательные модули

### UserProcessor
Центральный класс для обработки логики пользователей:
- Получение пользователей из БД
- Обработка страйков и пауз
- Управление подписками
- Анализ опасных случаев

### ReportGenerator
Класс для генерации отчетов и публичных сообщений:
- Отправка публичных напоминаний
- Вычисление времени
- Форматирование статистики
- Логирование в консоль

### AdminReporter
Централизованный класс для отправки отчетов админу:
- Отправка ежедневных отчетов (daily/allinfo)
- Отправка еженедельных отчетов
- Отправка отчетов об ошибках
- Улучшенное форматирование с дополнительной статистикой

### ChatManager
Класс для работы с Telegram чатом:
- Удаление пользователей из чата
- Отправка личных сообщений
- Отправка сообщений в группу/треды

## Использование

Основные функции экспортируются из `index.ts`:

```typescript
import { dailyCron, weeklyCron, publicDeadlineReminder, allInfo } from "./cronHandler/index.ts";

// Ежедневный крон
const response1 = await dailyCron();

// Еженедельный крон
const response2 = await weeklyCron();

// Публичное напоминание
const response3 = await publicDeadlineReminder();

// Детальный отчет
const response4 = await allInfo();
```

## Преимущества новой структуры

1. **Разделение ответственности** - каждый модуль отвечает за свою область
2. **Переиспользование кода** - общие функции вынесены в helpers
3. **Легкость тестирования** - каждый компонент можно тестировать отдельно
4. **Читаемость** - код разбит на логические блоки
5. **Масштабируемость** - легко добавить новые крон-задачи

## Миграция

Старый файл `cronHandler.ts` (786 строк) был разделен на:
- `flows/` - 4 файла (~100-150 строк каждый)
- `helpers/` - 4 файла (~100-200 строк каждый)
- `index.ts` - 40 строк

Общий объем кода остался примерно тот же, но организация стала намного лучше. 